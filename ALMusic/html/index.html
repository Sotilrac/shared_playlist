<!doctype html>
<!-- Tablet Resolution: 1707x1067 -->
<html lang="en">
  <head>
    <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon"> 
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <meta charset="utf-8" />
    <title>ALMusic </title>

    <script type="text/javascript">
     
     // get URL parameters by name
     function getParameterByName(name) {
       name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
       var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
       results = regex.exec(location.search);
       return results == null ? '' : decodeURIComponent(results[1].replace(/\+/g, " "));
     }

     //get robot name from url and determine robot address
     var robotName = getParameterByName('robot');
     var robotAddress = (robotName == '') ? '' : 'http://' + robotName + '.local';

     //List ids of sections to be shown/hidden
     var divIdList = ['ntc', 'nt', 'stats'];

     var colors = {}
     colors["blue"] = "#109EDC"
     colors["orange"] = "#E59230"
     colors["green"] = "#5ABF41"
     colors["teal"] = "#43C0C0"
     colors["red"] = "#EF2929"
     colors["purple"] = "#8265B2"
     colors["dpurp"] = "#5F3BD7"
     colors["efuchsia"] = "#C138A1"


     var robot_color = null

     /* var muted = false;
     var unmute_vol = 50; */

     //load appropriate qimessaging depending on running from robot or with a robot name specified in the URL
     document.write("<script type='text/javascript' src=" +
                             robotAddress +
                             "/libs/qimessaging/1.0/qimessaging.js><\/script>");
     </script>

     <!-- Load libs -->
     <script language="JavaScript" src="js/jquery-2.1.1.min.js"></script>
     <script language="JavaScript" src="js/jquery.qimhelpers.js"></script>
     <script language="JavaScript" src="js/jquery.textfill.min.js"></script>
     <script language="JavaScript" src="js/jquery-2.1..js"></script>

     <link rel="stylesheet" href="./css/style.css">
     <link rel="stylesheet" href="./css/font-awesome.min.css">

  </head>
  <body>

    <div id="dc" class="display_container">
      <div id="header" class="header">
        <div id="logo" class="logo">
        </div>
        <div id="title_c" class="title_container">
          <div id="title" class="title">
            ALMUSIC
          </div>
          <div id="dj" class="dj">
            <font face="Bebas">By:</font> <span id="robot_name"></span>
          </div>
        </div>
      </div>
      <div id="queue_c" class="queue_container">
        <div id="a_test" class="queue_active_card">
          Active test
        </div>
        <div id="test" class="queue_card">
          <div id="test-info" class="queue_card_info" 
               Artist: Carlos
               Song: Lavrova Caos
          </div>
          <div id="test-controls" class="queue_card_controls">
            UP DOWN X
          </div>
        </div>
        <div id="c_test" class="queue_clear_card">
          Clear
        </div>
      </div>
    </div>
    <div id="cc" class="control_container">
      <div id="control_pane" class="controls">
        <ul>
          <li><a id="am_play" class="btn" href="#"><i class="fa fa-play"></i></a></li>
          <li><a id="am_pause" class="btn" href="#"><i class="fa fa-pause"></i></a></li>
          <li><a id="am_stop" class="btn" href="#"><i class="fa fa-stop"></i></a></li>
          <li><a id="am_next" class="btn" href="#"><i class="fa fa-fast-forward"></i></a></li>
          <li>&nbsp;</li>
          <li>&nbsp;</li>
          <li><a id="am_vol_mute" class="btn" href="#"><i class="fa fa-volume-off"></i></a></li>
          <li><a id="am_vol_down" class="btn" href="#"><i class="fa fa-volume-down"></i></a></li>
          <li><a id="am_vol_up" class="btn" href="#"><i class="fa fa-volume-up"></i></a></li>
        </ul>
      </div>
    </div>

    <script type="text/javascript">

     //Layout and formatting
     // Displays a section given its ID and hides the other ones
     // uses divIdList
     function displaySection(id) {
       if (divIdList.indexOf(id)>-1) {
         var i = divIdList.indexOf(id);
         var list = divIdList.slice(0);
         list.splice(i, 1);
         console.log(list);
       }
       $('#'+id).fadeIn();
     }

     // URL paramters

     function reactToURL(){
       //valid commands
       var urlCommands = ['show_name_tag','show_stats'];
       
       for(var i in urlCommands) {
         var p = getParameterByName(urlCommands[i]);
         if (p!='') {
           switch (urlCommands[i]) {
             case 'show_name_tag':
               displaySection('nameTag');
               break;
             case 'show_stats':
               displaySection('stats');
               break;
           }
         }
       }
     }
     reactToURL();
     ///////////////////////////////////////////////

     //Change Qimessaging connection if robot name is passed in URL
     if (robotAddress != '') {
       $.qim = new QiSession(robotAddress);
     }

     function get_robot_name() {
       $.getService('ALSystem', function(ALSystem) {
         ALSystem.robotName().done(
           function (name){
             get_robot_color(name);
             $('#robot_name').html("DJ " + name ).css({'color': colors[robot_color]});
           })
       });
     }

     function get_robot_icon() {
       $.getService('ALSystem', function(ALSystem) {
         ALSystem.robotIcon().done(
           function (buffer){
             $('#logo').html("<img src=data:unknown;base64," + buffer + "></img>");
           })
       });
     }

     function get_robot_color(name) {
       name = name.toLowerCase();
       switch (name) {
         case "raphael":
           robot_color = "red";
           break;
         case "michelangelo":
           robot_color = "orange";
           break;
         case "donatello":
           robot_color = "dpurp";
           break;
         case "leonardo":
           robot_color = "blue";
           break;
         default:
           var sum = $.map(name.split(""), function(c) {return c.charCodeAt()}).reduce(function(a, b) {return a + b})
           color_idx = sum % Object.keys(colors).length
           robot_color = Object.keys(colors)[color_idx]           
       }
       $('body').css('background-color', colors[robot_color]);
       // PUT THAT FUNCTION BACK!!!!

     }

     function get_language() {
       $.getService('ALSpeechRecognition', function(ALSpeechRecognition) {
         ALSpeechRecognition.getLanguage().done(function (lang){
           var clang = $('#language_value').text();
           if (lang != clang) {
             $('#language_value').html(lang);
             switch(lang) {
               case "English":
                 switch_to_english();
                 break;
               case "Spanish":
                 switch_to_spanish();
                 break;
               case "French":
                 switch_to_french();
                 break;
               default:
                 console.log("Language currently unsupported; default to english");
                 switch_to_english();
             }
           }
         })
       });
     }

     function switch_to_english() {
       //$('#nt').css("background-image", "url(img/mni_"+robot_color+"_en.png)");
       //$('#naoqi_version_label').html("Version:");
       //$('#wireless_label').html("Network:");
       //$('#ip_label').html("IP:");
       //$('#battery_label').html("Battery:");
       //$('#temperature_label').html("Temperature (&deg;C):");
     }

     function switch_to_french() {
       /* $('#nt').css("background-image", "url(img/mni_"+robot_color+"_fr.png)");
       $('#naoqi_version_label').html("Version:");
       $('#wireless_label').html("Resseau:");
       $('#ip_label').html("IP:");
       $('#battery_label').html("Batterie:");
       $('#temperature_label').html("Temp&eacute;rature (&deg;C):"); */
     }

     function switch_to_spanish() {
       /* $('#nt').css("background-image", "url(img/mni_"+robot_color+"_es.png)");
       $('#naoqi_version_label').html("Versi&oacute;n:");
       $('#wireless_label').html("Red:");
       $('#ip_label').html("IP:");
       $('#battery_label').html("Bater&iacute;a:");
       $('#temperature_label').html("Temperatura (&deg;C):"); */
     }

     function zip(arrays) {
      return arrays[0].map(function(_,i){
        return arrays.map(function(array){return array[i]})
       });
      }

     /////////////////////////////
     // Control Button Handlers //
     /////////////////////////////

     function volume_control(action) {
       $.getService('ALAudioDevice', function(ALAudioDevice) {
         ALAudioDevice.getOutputVolume().done(
           function (volume){
             switch(action) {
               case "Up":
                 volume = volume + 5;
                 if (volume > 100){
                   volume = 100;
                 }
                 ALAudioDevice.setOutputVolume(volume);
                 break;
               case "Down":
                 volume = volume - 5;
                 if (volume < 0){
                   volume = 0;
                 }
                 ALAudioDevice.setOutputVolume(volume);
                 break;
               case "Mute":
                 ALAudioDevice.isAudioOutMuted().done(
                   function(muted){
                     if (muted) {
                       ALAudioDevice.muteAudioOut(false);
                     }
                     else {
                       ALAudioDevice.muteAudioOut(true);
                     }
                })
             }
           })
       });
     }
     
     $("#am_vol_mute").click(function() {
       volume_control("Mute");
     });

     $("#am_vol_down").click(function() {
       volume_control("Down");
     });

     $("#am_vol_up").click(function() {
       volume_control("Up");
     }); 

     function playback_control(action) {
       $.getService('ALMusic', function(ALMusic) {
         switch(action) {
           case "Play":
             ALMusic.playQueue();
             break;
           case "Pause":
             console.log("Pause functionality not implemented.");
             break;
           case "Stop":
             ALMusic.stop();
             break;
           case "Next":
             ALMusic.next();
             break;
         }
       });
     }

     $("#am_play").click(function() {
       playback_control("Play");
     });

     $("#am_pause").click(function() {
       playback_control("Pause");
     });

     $("#am_stop").click(function() {
       playback_control("Stop");
     });

     $("#am_next").click(function() {
       playback_control("Next");
     });

     //////////////////////////


     // ALMemory Subscriptions
     /* $.subscribeToALMemoryEvent('ALConnectionManager/NetworkServiceStateChanged', function(eventValue) {
     get_network();
     });
     
     $.subscribeToALMemoryEvent('ALBattery/BatteryChargeChanged', function(eventValue) {
     //get_battery();
     }); */

     // Connect/Disconnect signals
     $.qim.socket().on('connect', init() );

     function init() {
       $.when(get_robot_name()).done(function(){
         get_language();
       });
       get_robot_icon();
       $('body').fadeIn();
     }

     $.qim.socket().on('disconnect', function() {
       $('body').css('background-color','gray');
           });

    </script>
  </body>
</html>
